from __future__ import annotations

import asyncio

import structlog
from aiogram import Bot, Dispatcher, Router
from aiogram.filters import Command, CommandStart
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove

from vira.settings import settings
from infra.logging.logger import setup_logging
from infra.db.database import get_sessionmaker
from vira.db.repos.user_repo import UserRepo
from vira.db.repos.onboarding_repo import OnboardingRepo
from vira.db.repos.profile_repo import ProfileRepo
from vira.ai.engine import AIEngine


setup_logging()
log = structlog.get_logger()

router = Router()


def kb(*rows: list[str]) -> ReplyKeyboardMarkup:
    return ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text=t) for t in row] for row in rows],
        resize_keyboard=True,
        one_time_keyboard=True,
    )



@router.message(Command("restart"))

@router.message(Command("plan"))
async def plan_handler(message: Message):
    tg_id = str(message.from_user.id) if message.from_user else ""
    if not tg_id:
        return

    async_session = get_sessionmaker()
    async with async_session() as session:
        user_repo = UserRepo(session)
        u = await user_repo.get_or_create(tg_id)

        profile_repo = ProfileRepo(session)
        prof = await profile_repo.get(u.id)

        if not prof or not prof.data:
            await message.answer("Ø§ÙˆÙ„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ùˆ Ú©Ø§Ù…Ù„ Ú©Ù† ğŸ‘‡\n/start")
            return

        engine = AIEngine()
        out = await engine.generate_all(prof.data)

    st = out["strategy"]
    ideas = out["weekly_plan"]["ideas"]
    followups = out.get("followup_questions", [])

    lines = []
    lines.append("âœ… Ù¾Ù„Ù† Ø§ÙˆÙ„ÛŒÙ‡ Vira Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯")
    lines.append("")
    lines.append(f"**Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ:** {st['summary']}")
    lines.append(f"**Ù„Ø­Ù†:** {st['tone']} | **ÙØ±Ù…Øª:** {st['format']} | **Ø±ÛŒØªÙ…:** {st['cadence']}")
    lines.append("")
    lines.append("ğŸ”¥ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù‡ÙØªÙ‡:")
    for i, it in enumerate(ideas, 1):
        lines.append(f"{i}) {it['title']} â€” Ù‡ÙˆÚ©: {it['hook']} ({it['angle']})")
    lines.append("")
    lines.append("ğŸ§ª Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª:")
    lines.append(out["sample_script"]["script"])
    if followups:
        lines.append("")
        lines.append("Ø¨Ø±Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø´Ø¯Ù†ØŒ Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù‡:")
        for q in followups[:3]:
            lines.append(f"â€¢ {q}")

    await message.answer("\n".join(lines))
async def restart_handler(message: Message):
    tg_id = str(message.from_user.id) if message.from_user else ""
    async_session = get_sessionmaker()

    async with async_session() as session:
        user_repo = UserRepo(session)
        u = await user_repo.get_or_create(tg_id)

        onboarding_repo = OnboardingRepo(session)
        profile_repo = ProfileRepo(session)

        await onboarding_repo.delete(u.id)
        await profile_repo.delete(u.id)

    await message.answer("Ø±ÛŒØ³Øª Ø´Ø¯ âœ… Ø­Ø§Ù„Ø§ Ø§Ø² Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….", reply_markup=ReplyKeyboardRemove())
    # trigger start flow
    await start_handler(message)

@router.message(CommandStart())
async def start_handler(message: Message):
    tg_id = str(message.from_user.id) if message.from_user else ""
    async_session = get_sessionmaker()

    async with async_session() as session:
        user_repo = UserRepo(session)
        u = await user_repo.get_or_create(tg_id)

        onboarding_repo = OnboardingRepo(session)
        ob = await onboarding_repo.get_or_create(u.id)

        profile_repo = ProfileRepo(session)
        prof = await profile_repo.get(u.id)

    if prof and prof.completed_at:
        await message.answer("Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ØªÙˆ Ù‚Ø¨Ù„Ø§Ù‹ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡ âœ…\nØ§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ù†Ùˆ Ø¨Ø³Ø§Ø²ÛŒØŒ Ø¨Ú¯Ùˆ: /restart")
        return

    if ob.state == "Q1_LANGUAGE":
        await message.answer("Ø¨Ø±ÛŒÙ… Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒÙ… ğŸ‘‡\nØ²Ø¨Ø§Ù† Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒ Ú†ÛŒÙ‡ØŸ",
            reply_markup=kb(["ÙØ§Ø±Ø³ÛŒ", "Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ"])
        )
        return

    await message.answer("Ø§Ø¯Ø§Ù…Ù‡â€ŒÛŒ Ø¢Ù†Ø¨ÙˆØ±Ø¯ÛŒÙ†Ú¯ Ø±Ùˆ Ø¨Ú¯Ùˆ /start Ø¨Ø²Ù† ØªØ§ Ø§Ø² Ù‡Ù…ÙˆÙ†Ø¬Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯ÛŒÙ….")


async def main():
    log.info("bot_starting")

    if not settings.telegram_bot_token:
        raise SystemExit("TELEGRAM_BOT_TOKEN is empty. Put it in .env")
    bot = Bot(token=settings.telegram_bot_token)
    dp = Dispatcher()
    dp.include_router(router)
    log.info("bot_polling_started")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())

@router.message()
async def onboarding_answers(message: Message):
    tg_id = str(message.from_user.id) if message.from_user else ""
    text = (message.text or "").strip()
    if not tg_id or not text:
        return

    async_session = get_sessionmaker()
    async with async_session() as session:
        user_repo = UserRepo(session)
        u = await user_repo.get_or_create(tg_id)

        onboarding_repo = OnboardingRepo(session)
        ob = await onboarding_repo.get_or_create(u.id)

        profile_repo = ProfileRepo(session)
        prof = await profile_repo.get(u.id)

        # if completed, ignore
        if prof and prof.completed_at:
            await message.answer("Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ØªÙˆ Ù‚Ø¨Ù„Ø§Ù‹ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡ âœ…")
            return

        data = dict(ob.data or {})

        if ob.state == "Q1_LANGUAGE":
            if text not in {"ÙØ§Ø±Ø³ÛŒ", "Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ"}:
                await message.answer("ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ø²Ù† ğŸ‘‡", reply_markup=kb(["ÙØ§Ø±Ø³ÛŒ", "Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ"]))
                return
            data["language"] = "fa" if text == "ÙØ§Ø±Ø³ÛŒ" else "en"
            await onboarding_repo.set_data(u.id, data)
            await onboarding_repo.set_state(u.id, "Q2_NICHE")
            await message.answer(
                "Ø­ÙˆØ²Ù‡â€ŒÛŒ Ø§ØµÙ„ÛŒ Ù…Ø­ØªÙˆØ§Øª Ú†ÛŒÙ‡ØŸ",
                reply_markup=kb(["AI/ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ", "Ù…Ø§Ù„ÛŒ/Ú©Ø±ÛŒÙ¾ØªÙˆ", "Ø¢Ù…ÙˆØ²Ø´ÛŒ", "Ø³Ø±Ú¯Ø±Ù…ÛŒ", "Ù„Ø§ÛŒÙâ€ŒØ§Ø³ØªØ§ÛŒÙ„"], ["Ø³Ø§ÛŒØ±"])
            )
            return

        if ob.state == "Q2_NICHE":
            data["niche"] = text
            await onboarding_repo.set_data(u.id, data)
            await onboarding_repo.set_state(u.id, "Q3_GOAL")
            await message.answer(
                "Ù‡Ø¯Ù Ø§ØµÙ„ÛŒ ØªÙˆ Ú†ÛŒÙ‡ØŸ",
                reply_markup=kb(["Ø¯Ø±Ø¢Ù…Ø¯ Ø¯Ù„Ø§Ø±ÛŒ", "Ø±Ø´Ø¯ Ù…Ø®Ø§Ø·Ø¨ ÙØ§Ø±Ø³ÛŒ", "Ø¨Ø±Ù†Ø¯ Ø´Ø®ØµÛŒ", "ÙØ±ÙˆØ´ Ù…Ø­ØµÙˆÙ„/Ø³Ø±ÙˆÛŒØ³"])
            )
            return

        if ob.state == "Q3_GOAL":
            data["goal"] = text
            await onboarding_repo.set_data(u.id, data)

            # profile upsert + mark completed
            await profile_repo.upsert(u.id, data)
            await profile_repo.mark_completed(u.id)
            await onboarding_repo.set_state(u.id, "DONE")

            await message.answer(
                "Ø¹Ø§Ù„ÛŒ âœ… Ù¾Ø±ÙˆÙØ§ÛŒÙ„Øª Ú©Ø§Ù…Ù„ Ø´Ø¯.\nØ­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¨Ø±Ø§Øª Ù¾Ù„Ù† Ù…Ø­ØªÙˆØ§ Ùˆ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ø³Ø§Ø²Ù….",
                reply_markup=ReplyKeyboardRemove()
            )
            return

        await message.answer("Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡: /start")
